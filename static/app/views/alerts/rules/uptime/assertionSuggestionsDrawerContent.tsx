import styled from '@emotion/styled';

import {Alert} from '@sentry/scraps/alert';
import {Flex, Stack} from '@sentry/scraps/layout';
import {Heading} from '@sentry/scraps/text';

import {DrawerBody, DrawerHeader} from 'sentry/components/globalDrawer/components';
import LoadingError from 'sentry/components/loadingError';
import {IconSeer} from 'sentry/icons';
import {t} from 'sentry/locale';
import getApiUrl from 'sentry/utils/api/getApiUrl';
import {useApiQuery} from 'sentry/utils/queryClient';
import useOrganization from 'sentry/utils/useOrganization';
import {
  AssertionSuggestionCard,
  AssertionSuggestionCardPlaceholder,
} from 'sentry/views/alerts/rules/uptime/assertionSuggestionCard';
import type {
  AssertionSuggestion,
  AssertionSuggestionsResponse,
  PreviewCheckPayload,
} from 'sentry/views/alerts/rules/uptime/types';

interface AssertionSuggestionsDrawerContentProps {
  onApply: (suggestion: AssertionSuggestion) => void;
  payload: PreviewCheckPayload;
}

/**
 * Drawer content that owns its own data fetching lifecycle.
 * Rendered inside GlobalDrawer so DrawerHeader/DrawerBody work correctly.
 *
 * Uses useApiQuery with the payload as part of the cache key so that
 * re-opening the drawer for the same URL / method / headers / body
 * returns cached results instantly without a redundant API call.
 */
export function AssertionSuggestionsDrawerContent({
  payload,
  onApply,
}: AssertionSuggestionsDrawerContentProps) {
  const organization = useOrganization();

  const {data, isPending, isError, refetch} = useApiQuery<AssertionSuggestionsResponse>(
    [
      getApiUrl('/organizations/$organizationIdOrSlug/uptime-assertion-suggestions/', {
        path: {organizationIdOrSlug: organization.slug},
      }),
      {
        method: 'POST',
        data: {...payload},
      },
    ],
    {
      staleTime: 5 * 60 * 1000,
      retry: false,
    }
  );

  const suggestions = data?.suggestions ?? null;
  const isLoading = isPending;
  const hasEmptyResults = data && (!suggestions || suggestions.length === 0);

  return (
    <div>
      <DrawerHeader>
        <Flex gap="sm" align="center">
          <IconSeer />
          <Heading as="h3">{t('AI Assertion Suggestions')}</Heading>
        </Flex>
      </DrawerHeader>

      <ScrollableDrawerBody>
        <Alert.Container>
          <Alert variant="info">
            {t(
              'These suggestions are generated by AI based on the HTTP response. Review each suggestion before applying.'
            )}
          </Alert>
        </Alert.Container>

        {isLoading && <AssertionSuggestionCardPlaceholder />}

        {isError && (
          <LoadingError
            message={t(
              'Failed to generate assertion suggestions. The AI service may be temporarily unavailable.'
            )}
            onRetry={refetch}
          />
        )}

        {hasEmptyResults && (
          <Alert.Container>
            <Alert variant="warning">
              {t(
                'No suggestions were generated for this endpoint. Try a different URL or check that the endpoint returns a valid response.'
              )}
            </Alert>
          </Alert.Container>
        )}

        {suggestions && suggestions.length > 0 && (
          <Stack gap="md">
            {suggestions.map((suggestion, index) => (
              <AssertionSuggestionCard
                key={index}
                suggestion={suggestion}
                onApply={() => onApply(suggestion)}
              />
            ))}
          </Stack>
        )}
      </ScrollableDrawerBody>
    </div>
  );
}

const ScrollableDrawerBody = styled(DrawerBody)`
  flex: 1;
  overflow-y: auto;
`;
